{"componentChunkName":"component---src-templates-blog-post-js","path":"/elasitcbeanstalk-acm/","result":{"data":{"site":{"siteMetadata":{"title":"블로그 공사중"}},"markdownRemark":{"id":"cd6a8c5b-b5f6-587f-b77b-2329e9923fea","excerpt":"Elastic Beanstalk? 우선 AWS 문서를 보자: Elastic Beanstalk를 사용하면 애플리케이션을 실행하는 인프라에 대해 자세히 알지 못해도 AWS 클라우드에서 애플리케이션을 신속하게 배포하고 관리할 수 있습니다. Elastic Beanstalk…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/daab41e4d8504251ad33bddaa5e21607/c1b63/logo-eb-asm.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPUlEQVR42jXL+0tTYRwH4NcdL2k6d3S6M5eZ66J4rRxaeFmppTODUspqdDFIZYUGLsxbKrOrVoYXTmhok5ToQtFNs2y1rAb5/+yc9/1+CH/o+f1hemg7X8sU3zPFSjq9V+i1Fc9t8CuYtmDcjJFk+EzUayRvAnk2ieZo7o7hjVF6naRVGZgesm/kwFbxdScFSulDDhaS4E/9n2UMJ1G/iTqiqEMWrUZ+kvFjBq1O0ioNjP+282CGCOyg9bMUOIAfDViuwTM7VBnjKRhNxrCMRyV0u5DGauneYd6Zy5vTtFqmVUmMB+1iVaH1E7RaREt5WDuHJRdWzmAuCxNpmC5Gj0QPimiylnwO0VMgvAX8Sr5WzbRKiYkvNhF0UKiRPmZi7TRC7Zi3YHYL3jZAzYLqwJAMtYYGd5HaRBNNvC1DdDv1o3GakzH6ZKVvxRSsoz/n8deLXx4ELmHWjldHoOZiai9umGiqhgay6bGbFrv41TzeVaHXx2kVjNG7dHpjxXIZPh/CzxaErmPZDf9uzBRiRMGkg7wG3NlDI04xWCx6S4TPxVvyNCfTnBKjlza8sGHRjKcmLGYhcBlzObi/GXeNuJlEAzJdi6W+baI/X/jKRV8p92TrbfladWS4jDEsWDGvwG/FrAUzClQFDxNxPwW3ZAwkUncCdcaTJ0ZciOAXE3W3UXcx3RWtHZTC+xnbOE8smE6FmooJM8aSMWremEMm6k0gbzy1x4nWWNEcy09F6sclvT5SqzKEyyPC+yL+Ab/RTjT6kGuAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logo-eb-asm.png\"\n        title=\"\"\n        src=\"/static/daab41e4d8504251ad33bddaa5e21607/c1b63/logo-eb-asm.png\"\n        srcset=\"/static/daab41e4d8504251ad33bddaa5e21607/5a46d/logo-eb-asm.png 300w,\n/static/daab41e4d8504251ad33bddaa5e21607/0a47e/logo-eb-asm.png 600w,\n/static/daab41e4d8504251ad33bddaa5e21607/c1b63/logo-eb-asm.png 1200w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Elastic Beanstalk?</h2>\n<p>우선 <a href=\"https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/Welcome.html\">AWS 문서</a>를 보자:</p>\n<blockquote>\n<p>Elastic Beanstalk를 사용하면 애플리케이션을 실행하는 인프라에 대해 자세히 알지 못해도 AWS 클라우드에서 애플리케이션을 신속하게 배포하고 관리할 수 있습니다. Elastic Beanstalk를 사용하면 선택 또는 제어에 대한 제한 없이 관리 복잡성을 줄일 수 있습니다. 애플리케이션을 업로드하기만 하면 Elastic Beanstalk에서 용량 프로비저닝, 로드 밸런싱, 조정, 애플리케이션 상태 모니터링에 대한 세부 정보를 자동으로 처리합니다.</p>\n</blockquote>\n<p>위에서 말한 것 처럼, 적당히 세팅만 해 주면 AWS쪽에서 웹 서비스에서 필요한 기능들을 알아서 관리해 주기 때문에 처음 웹 서비스를 만들거나 MVP를 만들 때 사용하기 매우 편하다.\nHeroku 같은 서비스보다는 더 많은 부분을 컨트롤할 수 있고, ECS나 EKS처럼 컨테이너를 사용하는 서비스보다는 훨씬 관리해 주는 게 많은 서비스다.\n위에 말한 두 서비스의 적당한 절충안을 원하는 사람이라면 좋아할만한 서비스라고 생각한다.</p>\n<p>나는 개인적으로 Elastic Beanstalk(이하 EB)을 사용하는 걸 좋아한다.\n간단한 웹 서비스를 배포하는 데에 편리하고 적당히 중요한 기능들 다 있어서,\n생각보다 더 쓸만하고 사용하면서 치명적인 단점을 발견한 적은 딱히 없었다.</p>\n<p>그러던 어느날,\n그동안 EB를 쓰면서 ASM(AWS Secrets Manager)을 사용할 일이 없었는데,\n마침 사용하게 될 일이 생겨서 설정법을 찾아보던 도중 중요한 사실을 하나 깨달았다.</p>\n<h2>Elastic Beanstalk과 ASM을 연결하는 기능은 없다</h2>\n<p>그렇다. 같은 AWS 서비스임에도 불구하고 EB에서 ASM에 있는 시크릿 키를 받아와 사용할 수 있는 방법이 딱히 <strong>없다!</strong>\nEB 외부에서 값을 넣는 방법이 몇 가지 있는데, GUI에서 할 수 있는 방법은 Enviornment 값을 넣는 것이 전부이다.</p>\n<p>문서를 뒤져봐도 <a href=\"https://docs.aws.amazon.com/ko_kr/secretsmanager/latest/userguide/integrating_AEB.html\">개인 리포지토리를 호스팅하는 온라인 레지스트리를 사용하여 인증</a> 하는 방법에 대해서만 이야기할 뿐, EB env안에 ASM 값을 넣는 방법은 나오지 않았고,\n내 혈압도 같이 올라갔다.</p>\n<h2>그래도 넣어봅시다.</h2>\n<p>stack overflow를 뒤져보면서 얻은 결론은 \"awscli로 커맨드 받아서 직접 넣기\" 였다.\nawscli를 사용하는 거야 쉽다. 이런 식으로 ASM에서 secret key를 받아올 수 있다:</p>\n<deckgo-highlight-code   >\n          <code slot=\"code\">aws secretsmanager get-secret-value --secret-id ${AWS_SECRET_ID} | jq &quot;.SecretString | fromjson | to_entries[] | [.key,.value] | join(\\&quot;=\\&quot;)&quot; </code>\n        </deckgo-highlight-code>\n<p>이렇게 하면 json 형태로 받아온 secret key를 .env에서 사용하는 <code>AAA=BBB</code> 형태로 가져올 수 있고,\n파일로 저장하면 된다.\n다만 받아온 키를 어디에 넣어야 하는지가 문제인데,\n여러가지 방법을 써 본 결과 docker-compose를 이용해 값을 가져오는게 제일 괜찮은 방법이었다.</p>\n<h2>Dockerfile 직접 넣기보다 docker-compose.yml를 사용하자</h2>\n<p>이전에 나는 주로 Dockerfile을 직접 넣어서 빌드를 하는 방식을 주로 사용했다.\n소스 코드와 Dockerfile을 넣으면 EB에서 알아서 docker build를 하고 배포를 하는데,\n몇 가지 불편한 점이 있다.</p>\n<ul>\n<li>\n<p>인스턴스 스펙이 낮으면 빌드 시 램 부족으로 터질 수 있다.</p>\n<ul>\n<li>EB에서는 docker build도 해당 인스턴스로 하기 때문에,\nFrontend 배포 할 때 npm build 등으로 큰 소스들을 빌드하다 보면 OOM이 발생하는 경우가 생각보다 많다.</li>\n</ul>\n</li>\n<li>\n<p>secret key 넣는 과정에 애로사항이 생긴다.</p>\n<ul>\n<li>Dockerfile만을 사용할 경우 <code>/var/app/current/.env</code> 값에 secret key를 넣어야 하는데,\nEB에서 env 값을 바꿀 떄 <code>.env</code> 파일을 수정하기 때문에 값이 덮어씌워질 일이 생긴다.</li>\n</ul>\n</li>\n</ul>\n<p>그럼 어떻게 하는 게 좋을까? 쉽다. docker-compose도 지원하기 때문에,\nCD 단계에서 docker build를 하고, ECR(Elastic Container Registry)에 docker 이미지를 올려둔 뒤 가져오면 된다.</p>\n<hr>\n<p>여기서 잠깐, 왜 <code>/var/app/current/.env</code> 일까?</p>\n<p>그걸 알기 위해선 EB가 어떤 구조로 돌아가는지 알 필요가 있다.\nEB는 ELB + EC2 + ASG 등을 AWS에서 미리 만들어 둔 CloudFormation 템플릿을 이용해서 배포를 하는 시스템이다.\n그래서 EB 자체는 사용료가 부가되지 않지만, EB에서 배포하면서 만들어지는 다른 서비스들에서 비용이 부과가 된다.</p>\n<p>EB에서 생성한 EC2 안으로 들어가 보면,\n소스를 받고 가공을 하는 동안은 <code>/var/app/staging/</code>에서 작업을 하고,\n그 후 실행할 땐 <code>/var/app/current/</code>에서 돌아간다는 것을 알 수 있다.\n그러니 빌드 전에 secret key를 해당 디렉토리 안에 넣어서 돌아가게 할 수 있는 것이다.</p>\n<h2>.platform/ script 사용하기</h2>\n<p>EB에서는 코드 배포 전/후에 스크립트를 따로 돌릴 수 있는 방법들을 제공하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 566px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 207.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"eb_steps.png\"\n        title=\"\"\n        src=\"/static/9f4bfac4c06c090bea350551e36083f3/6fe44/eb_steps.png\"\n        srcset=\"/static/9f4bfac4c06c090bea350551e36083f3/5a46d/eb_steps.png 300w,\n/static/9f4bfac4c06c090bea350551e36083f3/6fe44/eb_steps.png 566w\"\n        sizes=\"(max-width: 566px) 100vw, 566px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n(출처: <a href=\"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html\">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html</a>)</p>\n<p>위 사진과 같이 EB는 배포 시 총 3가지 step을 진행하는데, 중간 중간에 스크립트를 실행할 수 있다.\n<code>.platform/</code> 디렉토리 안에 넣으면 해당 스크립트를 실행할 수 있는데,\n우리는 prebuild 단계에서 secret key를 만들어 넣을 예정이다.</p>\n<p>다음과 같은 위치에 파일 두 개를 만들어야 한다.</p>\n<deckgo-highlight-code   >\n          <code slot=\"code\">.platform/hooks/prebuild/get_secret_key.sh\n.platform/confighooks/prebuild/get_secret_key.sh</code>\n        </deckgo-highlight-code>\n<p>confighooks는 무엇인가? 배포 뿐만 아니라 인스턴스 구성을 바꿀 때(env 값 변경 등)에도 스크립트를 돌릴 수 있다.\nconfighooks/ 디렉토리에 넣으면 실행 가능하다.</p>\n<p>그럼 스크립트 안에는 어떤 값을 넣어야 하는가?\n실행하는 EB 위치에 .secret 파일을 넣어주면 된다.</p>\n<deckgo-highlight-code   >\n          <code slot=\"code\">#!/bin/bash\n\n$( echo &quot;$(/opt/elasticbeanstalk/bin/get-config environment)&quot; | jq -r &#39;keys[] as $k | &quot;export \\($k)=\\(.[$k])&quot;&#39; ) # load ElasticBeanstalk env\n\naws secretsmanager get-secret-value --secret-id ${AWS_SECRET_ID} | jq &quot;.SecretString | fromjson | to_entries[] | [.key,.value] | join(\\&quot;=\\&quot;)&quot; -r &gt; /var/app/staging/.secret\n\naws secretsmanager get-secret-value --secret-id ${AWS_SECRET_ID} | jq &quot;.SecretString | fromjson | to_entries[] | [.key,.value] | join(\\&quot;=\\&quot;)&quot; -r &gt; /var/app/current/.secret</code>\n        </deckgo-highlight-code>\n<p>이 스크립트를 실행하게 되면 <code>/var/app/staging/.secret</code>, <code>/var/app/current/.secret</code> 두 곳에 <code>.secret</code> 파일을 만들게 된다.\n두 곳 모두 만들어야 한다. 그렇지 않으면 배포 시 에러가 발생한다.</p>\n<p>그리고 docker-compose에는 다음과 같이 .secret 파일을 읽도록 설정하면 끝.</p>\n<deckgo-highlight-code   >\n          <code slot=\"code\">version: &#39;3.1&#39;\n\nservices:\n  app:\n    image: {docker image} # ECR에 올린 도커 이미지\n    env_file:\n      - .env # Elastic Beanstalk에서 Environment 값을 넣으면 들어가는 파일\n      - .secret # 아까 만들었던 ASM으로 로드한 secret key\n    ... # 나머지 기타등등 설정\n</code>\n        </deckgo-highlight-code>\n<p>이렇게 하면 EB + ECR + ASM 조합으로 애플리케이션을 간단하게 배포할 수 있다.</p>\n<h2>Reference</h2>\n<p><a href=\"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/single-container-docker-configuration.html\">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/single-container-docker-configuration.html</a></p>\n<p><a href=\"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html\">https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html</a></p>\n<p><a href=\"https://stackoverflow.com/questions/35788499/what-is-the-difference-between-commands-and-container-commands-configuration-key\">https://stackoverflow.com/questions/35788499/what-is-the-difference-between-commands-and-container-commands-configuration-key</a></p>","frontmatter":{"title":"Elastic Beanstalk에서 Secret Manager 사용하기","date":"September 22, 2023","description":"생각보다 척척 안 된다."}},"previous":{"fields":{"slug":"/vite-dev-cons/"},"frontmatter":{"title":"Dev mode에서 Vite는 너무 무겁다"}},"next":{"fields":{"slug":"/about/"},"frontmatter":{"title":"About"}}},"pageContext":{"id":"cd6a8c5b-b5f6-587f-b77b-2329e9923fea","previousPostId":"70801943-da03-5c98-9ae6-534891604457","nextPostId":"2d6f7e10-7009-587e-8879-e07132c679c6"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}